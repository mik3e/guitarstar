<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title id="page-title"></title>
  <style>
    body { font-family: sans-serif; text-align: center; }
    button { margin: 5px; padding: 8px 16px; font-size: 14px; }
    svg { border: 1px solid #aaa; margin-top: 10px; }
    .fret-label { font-size: 12px; fill: black; }
    .note { cursor: pointer; font-size: 12px; font-weight: bold; }
  </style>
  <script>
    const appTitle = "Guitar Periodic System";
    document.addEventListener("DOMContentLoaded", () => {
      document.title = appTitle;
      document.getElementById("header-title").textContent = appTitle;
    });
  </script>
</head>
<body>

  <style>
    body { 
      font-family: sans-serif; 
      text-align: center; 
      background-color: #fbf1db; /* New background color */
      color: #333; /* Adjust text color for better contrast */
    }
    button { 
      margin: 5px; 
      padding: 8px 16px; 
      font-size: 14px; 
      background-color: #eac097; /* Complementary button color */
      color: #000; /* White text for contrast */
      border: none; 
      border-radius: 5px; /* Rounded corners */
      cursor: pointer; 
    }
    button:hover { 
      background-color: #cea583; /* Darker shade for hover effect */
    }
    svg { 
      border: 1px solid #aaa; 
      margin-top: 10px; 
    }
    .fret-label { 
      font-size: 12px; 
      fill: black; 
    }
    .note { 
      cursor: pointer; 
      font-size: 12px; 
      font-weight: bold; 
    }
  </style>  

  <img id="header-image" src="gps.png" alt="Guitar Periodic System" style="width: 300px; height: auto; margin-top: 20px;">
  <br>
  <!-- <h1 id="header-title"></h1> -->
  <!-- <h3>The Audio-Visual Guide to Guitar Notes and Chords</h3> -->
  <button onclick="toggleOctaves()">Toggle Octaves</button>
  <button onclick="toggleFrequencies()">Toggle Frequencies</button>
  <button onclick="toggleSharps()">Toggle Sharps</button>
  <button onclick="toggleFredHighlighting()">Toggle Freds</button>

  <!-- <button onclick="toggleFredHighlighting()" style="font-size: 30px;">ùÑû</button> -->

  <svg onclick="playSelectedNotes()" width="34.2" height="34.2" style="cursor: pointer; margin: 7.125px; vertical-align: middle;">
    <polygon points="0,0 34.2,17.1 0,34.2" fill="black" />
  </svg>

  <button onclick="useNoColoring()">Use No Colors</button>
  <button onclick="useNoteColoring()">Use Note Type Colors</button>
  <button onclick="useOctaveColoring()">Use Octave Colors</button>

  <br>
    
  <svg id="fretboard" width="1100" height="340"></svg>
  
  <!-- Chord input field -->
  <div style="margin-top: 10px;"></div>
    <input type="text" id="chordInput" placeholder="Enter a chord (e.g. Cmaj, Em7, D#dim, ..)" 
           style="width: 250px; background-color: #fbf1db; color: #000; border: 1px solid #888888; border-radius: 5px; padding: 5px;" 
           onkeypress="if(event.key === 'Enter') highlightChordNotes();">
    <button onclick="highlightChordNotes()">Show Chord Notes</button>
  </div>

  <!-- Scale input field -->
  <div style="margin-top: 10px;">
    <input type="text" id="scaleInput" placeholder="Enter a scale (e.g. C-Dur, A-Moll)" 
          style="width: 250px; background-color: #fbf1db; color: #000; border: 1px solid #888888; border-radius: 5px; padding: 5px;" 
          onkeypress="if(event.key === 'Enter') highlightScaleNotes();">
    <button onclick="highlightScaleNotes()">Show Scale Notes</button>
  </div>


  <script>
    const svg = document.getElementById("fretboard");
    const strings = [
      ['E', 4], ['B', 3], ['G', 3], ['D', 3], ['A', 2], ['E', 2]
    ];
    const noteNames = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
    const naturalNotes = new Set(['C','D','E','F','G','A','B']);
    const octaveColors = {
      2: '#FFB6C1', // Light Pink
      3: '#20B2AA', // Light Sea Green
      4: '#FFA07A', // Light Salmon
      5: '#FFD700'  // Gold
    };
    const numFrets = 15;
    let showOctaves = true;
    let showSharps = true;
    let isHighlightFreds = true;
    let useOctaveColorsFlag = true;
    let useNoColorsFlag = false;
    let showFrequencies = true;
    let selected = new Set();

    function saveState() {
      const state = {
        showOctaves,
        showSharps,
        showFrequencies,
        isHighlightFreds,
        useOctaveColorsFlag,
        useNoColorsFlag,
        selected: Array.from(selected),
        chordInput: document.getElementById("chordInput").value
      };
      localStorage.setItem('guitarState', JSON.stringify(state));
    }

    function loadState() {
      const saved = localStorage.getItem('guitarState');
      if (!saved) return;
      try {
        const state = JSON.parse(saved);
        showOctaves = state.showOctaves ?? true;
        showSharps = state.showSharps ?? true;
        showFrequencies = state.showFrequencies ?? true;
        isHighlightFreds = state.isHighlightFreds ?? true;
        useOctaveColorsFlag = state.useOctaveColorsFlag ?? true;
        useNoColorsFlag = state.useNoColorsFlag ?? false;
        selected = new Set(state.selected ?? []);
        if (state.chordInput !== undefined) {
          document.getElementById("chordInput").value = state.chordInput;
        }
        drawFretboard();
      } catch (e) {
        console.error("Failed to load saved state:", e);
      }
    }

    function playSelectedNotes() {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const fretboard = getFretboard();

      selected.forEach(id => {
        const [col, row] = id.split(',').map(Number);
        const noteObj = fretboard[row][col];
        const freq = getFrequency(noteObj.name, noteObj.octave);
        playGuitarLikeNote(audioCtx, freq);
      });
    }

    function playGuitarLikeNote(audioCtx, frequency) {
      const now = audioCtx.currentTime;
      const duration = 3.5;

      // Master gain with pluck envelope
      const masterGain = audioCtx.createGain();
      masterGain.gain.setValueAtTime(0.0001, now);
      masterGain.gain.exponentialRampToValueAtTime(1.0, now + 0.01); // Attack
      masterGain.gain.exponentialRampToValueAtTime(0.5, now + 0.3);  // Decay
      masterGain.gain.exponentialRampToValueAtTime(0.0001, now + duration); // Release
      masterGain.connect(audioCtx.destination);

      // Lowpass filter to mellow out over time
      const filter = audioCtx.createBiquadFilter();
      filter.type = "lowpass";
      filter.frequency.setValueAtTime(5000, now);
      filter.frequency.exponentialRampToValueAtTime(800, now + duration);
      filter.connect(masterGain);

      // Noise burst for pluck snap
      const noiseBuffer = audioCtx.createBuffer(1, audioCtx.sampleRate * 0.02, audioCtx.sampleRate);
      const data = noiseBuffer.getChannelData(0);
      for (let i = 0; i < data.length; i++) {
        data[i] = (Math.random() * 2 - 1) * Math.exp(-i / 100); // Short decay
      }

      const noise = audioCtx.createBufferSource();
      noise.buffer = noiseBuffer;

      const noiseGain = audioCtx.createGain();
      noiseGain.gain.setValueAtTime(0.2, now);
      noiseGain.gain.exponentialRampToValueAtTime(0.0001, now + 0.02);

      noise.connect(noiseGain).connect(filter);
      noise.start(now);

      // Create harmonics with dynamic vibrato and panning
      for (let i = 1; i <= 5; i++) {
        const osc = audioCtx.createOscillator();
        osc.type = i === 1 ? "triangle" : "sine";
        const harmonicFreq = frequency * i;
        osc.frequency.setValueAtTime(harmonicFreq, now);

        // Micro pitch vibrato ("string swing")
        const lfo = audioCtx.createOscillator();
        lfo.frequency.setValueAtTime(4 + Math.random() * 2, now); // 4‚Äì6 Hz
        const lfoGain = audioCtx.createGain();
        lfoGain.gain.setValueAtTime(0.5 / i, now); // less swing for higher harmonics
        lfo.connect(lfoGain).connect(osc.frequency);
        lfo.start(now);
        lfo.stop(now + duration);

        const partialGain = audioCtx.createGain();
        partialGain.gain.setValueAtTime(1 / (i * i), now); // roll off harmonics

        // Slight stereo spread
        const panner = new StereoPannerNode(audioCtx, {
          pan: (Math.random() * 2 - 1) * 0.3
        });

        osc.connect(partialGain).connect(panner).connect(filter);
        osc.start(now);
        osc.stop(now + duration);
      }
    }


    function noteIndex(note) {
      return noteNames.indexOf(note);
    }

    function getFretboard() {
      const fretboard = [];
      for (let [note, octave] of strings) {
        const notes = [];
        let start = noteIndex(note);
        let currentOctave = octave;
        for (let fret = 0; fret <= numFrets; fret++) {
          let idx = (start + fret) % 12;
          let name = noteNames[idx];
          if (fret > 0 && noteNames[(start + fret - 1) % 12] === 'B' && name === 'C') {
            currentOctave++;
          }
          notes.push({ name, octave: currentOctave });
        }
        fretboard.push(notes);
      }
      return fretboard;
    }

    function getFrequency(noteName, octave) {
      const A4_INDEX = 9; // A is index 9 in noteNames
      const A4_OCTAVE = 4;
      const A4_FREQ = 440;
      
      const noteIndexVal = noteNames.indexOf(noteName);
      const semitoneDiff = (octave - A4_OCTAVE) * 12 + (noteIndexVal - A4_INDEX);
      return A4_FREQ * Math.pow(2, semitoneDiff / 12);
    }

    function shadeColor(color, percent) {
      let f = parseInt(color.slice(1), 16),
      t = percent < 0 ? 0 : 255,
      p = Math.abs(percent) / 100,
      R = f >> 16,
      G = f >> 8 & 0x00FF,
      B = f & 0x0000FF;
      return "#" + (
      0x1000000 +
      (Math.round((t - R) * p) + R) * 0x10000 +
      (Math.round((t - G) * p) + G) * 0x100 +
      (Math.round((t - B) * p) + B)
      ).toString(16).slice(1);
    }

    function drawFretboard() {
    svg.innerHTML = '';
    const width = 1050, height = 300;
    const cellW = width / (numFrets + 1);
    const cellH = height / 6;
    const xOffset = 50;
    const fretboard = getFretboard();
    const highlightedFretNumbers = new Set([0, 3, 5, 7, 9, 12]);

    fretboard.forEach((string, row) => {
      const visualRow = row; // 0 (string 1) to 5 (string 6)
      string.forEach((noteObj, col) => {
        const x = xOffset + col * cellW;
        const y = visualRow * cellH;
        const id = `${col},${row}`;
        const defaultColor = '#ffdab9'; // Peach Puff
        const naturalNodeColor = '#cea583'; // Pastel Grayish Blue
        let color = defaultColor;
        if (!useNoColorsFlag) {
          if (useOctaveColorsFlag) {
            color = octaveColors[noteObj.octave] || defaultColor;
          } else {
            if (naturalNotes.has(noteObj.name)){
              color = naturalNodeColor;
            }
          }
        }

        const isSelected = selected.has(id);
        const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
        rect.setAttribute("x", x);
        rect.setAttribute("y", y);
        rect.setAttribute("width", cellW);
        rect.setAttribute("height", cellH);
        
        let finalColor = color;
        // Darken color slightly for highlighted frets
        if (highlightedFretNumbers.has(col) && isHighlightFreds) {
          finalColor = shadeColor(color, -35);
        }
        rect.setAttribute("fill", isSelected ? "lightgreen" : finalColor);
        rect.setAttribute("stroke", "black");

        // Note label (centered vertically)
        const textNote = document.createElementNS("http://www.w3.org/2000/svg", "text");
        textNote.setAttribute("x", x + cellW / 2);
        textNote.setAttribute("y", y + cellH / 2+4);
        textNote.setAttribute("text-anchor", "middle");
        textNote.setAttribute("class", "note");
        let labelText = showOctaves ? `${noteObj.name}${noteObj.octave}` : noteObj.name;
        textNote.textContent = !showSharps && noteObj.name.includes('#') ? '' : labelText;

        // Frequency label (optional) placed below the note label
        let textFreq = null;
        if (showFrequencies && (!noteObj.name.includes('#') || showSharps)) {
          textFreq = document.createElementNS("http://www.w3.org/2000/svg", "text");
          textFreq.setAttribute("x", x + cellW / 2);
          textFreq.setAttribute("y", y + cellH / 2 + 16);
          textFreq.setAttribute("text-anchor", "middle");
          textFreq.setAttribute("font-size", "10");
          textFreq.setAttribute("fill", "black");
          const freq = Math.round(getFrequency(noteObj.name, noteObj.octave));
          textFreq.textContent = `${freq} Hz`;
        }

        rect.addEventListener("click", () => {
          if (selected.has(id)) selected.delete(id);
          else selected.add(id);
          drawFretboard();
          saveState();
        });
        textNote.addEventListener("click", () => {
          if (selected.has(id)) selected.delete(id);
          else selected.add(id);
          drawFretboard();
          saveState();
        });

        svg.appendChild(rect);
        svg.appendChild(textNote);
        if (textFreq) svg.appendChild(textFreq);
      });
    });

    // String labels (1 to 6, top to bottom)
    strings.forEach(([note, octave], i) => {

      // Note label (centered vertically)
      const textNote = document.createElementNS("http://www.w3.org/2000/svg", "text");
      textNote.setAttribute("x", cellW / 2);
      textNote.setAttribute("y", i * cellH + cellH / 2 + 4);
      textNote.setAttribute("text-anchor", "middle");
      textNote.setAttribute("class", "fret-label");
      textNote.textContent = `${i + 1}`;
      svg.appendChild(textNote);
    });

    // Add horizontal label: "Strings" (left side, vertical text)
    const stringsLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
    stringsLabel.setAttribute("x", -height / 2);
    stringsLabel.setAttribute("y", 15);
    stringsLabel.setAttribute("transform", `rotate(-90)`);
    stringsLabel.setAttribute("text-anchor", "middle");
    stringsLabel.setAttribute("font-size", "14");
    stringsLabel.setAttribute("font-weight", "bold");
    stringsLabel.textContent = "Strings";
    svg.appendChild(stringsLabel);

    // Add bottom label: "Freds" (centered under fretboard)
    const fredsLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
    fredsLabel.setAttribute("x", xOffset+width / 2);
    fredsLabel.setAttribute("y", height + 35);
    fredsLabel.setAttribute("text-anchor", "middle");
    fredsLabel.setAttribute("font-size", "14");
    fredsLabel.setAttribute("font-weight", "bold");
    fredsLabel.textContent = "Freds";
    svg.appendChild(fredsLabel);

    // Fret labels
    for (let f = 0; f <= numFrets; f++) {
      const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
      label.setAttribute("x", xOffset + f * cellW + cellW / 2);
      label.setAttribute("y", height + 20);
      label.setAttribute("text-anchor", "middle");
      label.setAttribute("class", "fret-label");
      if (highlightedFretNumbers.has(f) && isHighlightFreds) {
        label.setAttribute("font-weight", "bold"); // Make the label bold
        label.setAttribute("stroke", "red"); // Add a blue stroke around the text
        label.setAttribute("stroke-width", "0.5"); // Set stroke width
      }
      label.textContent = f;
      svg.appendChild(label);      
    }
  }

    function highlightScaleNotes() {
      const input = document.getElementById("scaleInput").value.trim();
      if (!input) return;

      const scaleMap = {
        'dur': [0, 2, 4, 5, 7, 9, 11],    // Major scale intervals
        'moll': [0, 2, 3, 5, 7, 8, 10],   // Natural minor scale intervals
      };

      const match = input.toLowerCase().match(/^([a-g](#|b)?)[-\s]*(dur|moll)$/i);
      if (!match) {
        alert("Please use the format 'C-Dur' or 'A-Moll'");
        return;
      }

      const [_, rootRaw, accidental, type] = match;
      const root = (rootRaw + (accidental || '')).toUpperCase();
      const intervals = scaleMap[type.toLowerCase()];
      if (!intervals) return;

      const rootIndex = noteNames.indexOf(root);
      if (rootIndex === -1) {
        alert(`Unknown note: ${root}`);
        return;
      }

      const scaleNotes = intervals.map(i => noteNames[(rootIndex + i) % 12]);

      const fretboard = getFretboard();
      selected.clear();
      for (let row = 0; row < fretboard.length; row++) {
        for (let col = 0; col < fretboard[row].length; col++) {
          const note = fretboard[row][col].name;
          if (scaleNotes.includes(note)) {
            selected.add(`${col},${row}`);
          }
        }
      }

      drawFretboard();
      saveState();
    }

    function toggleOctaves() {
      showOctaves = !showOctaves;
      drawFretboard();
      saveState();
    }

    function toggleSharps() {
      showSharps = !showSharps;
      drawFretboard();
      saveState();
    }

    function toggleFredHighlighting() {
      isHighlightFreds = !isHighlightFreds;
      drawFretboard();
      saveState();
    }    

    function toggleFrequencies() {
      showFrequencies = !showFrequencies;
      drawFretboard();
      saveState();
    }
    
    function useNoColoring() {
      useOctaveColorsFlag = false;
      useNoColorsFlag = true;
      drawFretboard();
      saveState();
    }

    function useNoteColoring() {
      useOctaveColorsFlag = false;
      useNoColorsFlag = false;
      drawFretboard();
      saveState();
    }

    function useOctaveColoring() {
      useOctaveColorsFlag = true;
      useNoColorsFlag = false;
      drawFretboard();
      saveState();
    }

    function getChordNotes(chord) {
    const chordFormulas = {
      'maj': [0, 4, 7],
      'min': [0, 3, 7],
      '7': [0, 4, 7, 10],
      'maj7': [0, 4, 7, 11],
      'min7': [0, 3, 7, 10],
      'dim': [0, 3, 6],
      'aug': [0, 4, 8],
      'sus2': [0, 2, 7],
      'sus4': [0, 5, 7],
      'add9': [0, 4, 7, 14],
      'minadd9': [0, 3, 7, 14]
    };

    const notes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

    function getNotesForChord(root, formula) {
      return formula.map(interval => notes[(root + interval) % 12]);
    }

    chord = chord.trim();
    const chordRegex = /^([A-Ga-g]#?)(maj7?|min7?|dur7?|moll7?|dim|aug|sus[24]?|add9|minadd9|7)?$/i;
    const match = chord.match(chordRegex);
    if (!match) return "Invalid Chord";

    const rootNote = match[1].toUpperCase();
    let chordType = match[2] ? match[2].toLowerCase() : 'maj';

    const altNames = {
      'dur': 'maj',
      'moll': 'min',
      'dur7': 'maj7',
      'moll7': 'min7'
    };
    if (altNames[chordType]) {
      chordType = altNames[chordType];
    }

    const rootIndex = notes.indexOf(rootNote);
    if (rootIndex === -1) return "Invalid root note.";
    if (!chordFormulas[chordType]) return "Invalid chord type.";

    const formula = chordFormulas[chordType];
    return getNotesForChord(rootIndex, formula);
  }

    function highlightChordNotes() {
      const chord = document.getElementById("chordInput").value.trim();
      
      if (chord === "") {
        selected.clear();
        drawFretboard();
        saveState();
        return;
      }

      const chordNotes = getChordNotes(chord);
      
      if (Array.isArray(chordNotes)) {
        selected.clear();
        const fretboard = getFretboard();
        
        fretboard.forEach((string, row) => {
          string.forEach((noteObj, col) => {
            if (chordNotes.includes(noteObj.name)) {
              const id = `${col},${row}`;
              selected.add(id);
            }
          });
        });
        drawFretboard();
        saveState();
      } else {
        const messageBox = document.createElement("div");
        messageBox.textContent = chordNotes; // Show error message if invalid chord
        messageBox.style.position = "fixed";
        messageBox.style.top = "470px";
        messageBox.style.left = "50%";
        messageBox.style.transform = "translateX(-50%)";
        messageBox.style.backgroundColor = "rgba(255, 77, 77, 0.75)"; // More prominent red color with 25% transparency
        messageBox.style.color = "#ffffff"; // White text for better contrast
        messageBox.style.padding = "50px"; // Increased padding for larger size
        messageBox.style.border = "1px solid rgba(200, 200, 200, 0.75)";
        messageBox.style.borderRadius = "10px"; // Slightly larger border radius
        messageBox.style.fontSize = "32px"; // Doubled font size
        messageBox.style.zIndex = "1000";
        document.body.appendChild(messageBox);

        setTimeout(() => {
          document.body.removeChild(messageBox);
        }, 3000);
      }
    }

    // Initial rendering
    loadState();
    drawFretboard();
  </script>
</body>
</html>
